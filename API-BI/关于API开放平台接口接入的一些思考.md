# 关于API开放平台接口接入的一些思考

最近在将API开放平台和做过的一些项目进行接入。发现了很多可以拿出来说说的点。我这边就拿BI项目举例，让我们开始吧。

## 1. 网关和API都有限流策略，应该走谁的限流策略？

我们知道，BI项目中使用了redisson的令牌桶算法对请求进行限流。在网关中，我们通常也需要制定一些限流策略，去应对高并发的场景。

这样就出现了一个问题，就是我们的请求会经过两个漏斗，虽然这个问题在绝大多数情况都不是问题，但是这样就很不得劲。

对于API来说，想要限流，首先你要登录呀！尽管能通过ak/sk获得用户中心的这个user的数据，但这样不就多此一举吗？

在我看来，限流策略应该全部走网关的。而API的限流策略该怎么告诉网关呢？

别忘了，我们的API是通过MySQL存储的，这边留个小伏笔，后面还会讲到这个。

我们在API中添加几个限流的参数，这样不就可以做到API自定义限流了吗？

结论：限流策略在我看来，走网关是最合适的，API就老老实实干自己的活吧。

## 2. 调用次数，应该交给API管理还是网关管理？

其实大家看到这个问题一定会脱口而出：肯定是网关统一管理啊！

我们还是拿BI系统举例，BI中对每个用户都有调用次数统计，API中也有调用次数统计的逻辑。

这边我们就会初见端倪。BI是有自己的服务的，也就是说BI存在调用次数统计是合理的。而BI又要出一个API接入到开放平台。这就有点麻烦了。

最简单的方法是直接同步。但是这样的话，服务多了，也吃不消。

我给API划分了两种：

1. 纯API。
2. 有后端的API，有自己的接口调用限制，如BI平台。

对于纯API来说，接口的调用计数直接使用用户中心的user_api_info即可。

对于有后端的API来说，该API的调用计数可能受其服务的调用计数限制。网关不好与该API进行同步。

策略是：该API作为noInvokeLimit开放，但是对用户的调用进行计数。也就是将调用次数交给API管理。

## 3. 后端如何对服务自动接入，即添加接口信息后即可直接使用？

我认为这是一个不错的亮点。

首先，这个问题关键是网关该怎么做路由的注册。如果只依靠配置，尽管可以依靠nacos的动态配置，整体上还是无法做到动态更新路由。

我们可以将api_info表再次扩展，这就是我刚刚提到的小伏笔。api_info又要进行升级了，他承担了路由注册的责任，因此需要添加各个参数字段如path、uri、route_id，同时需要再暴露一个获得api_info表所有记录的方法，以供网关做注册。

最后，我们的路由不再写死在application.yml中，而是通过配置类去将上述参数动态注册路由。

```java
// 调用远程服务获取list
List<ApiInfo> apiInfoList = innerApiInfoService.getApiInfoList();

RouteLocatorBuilder.Builder routes = builder.routes();
// 遍历list去注册路由
for (ApiInfo apiInfo : apiInfoList) {
    try{
        routes.route(
                apiInfo.getRouteId(),
                r -> r.path(apiInfo.getPath())
                .uri(apiInfo.getUri())
                );
        log.info("------------ routeId:{} ; name:{}初始化成功。",apiInfo.getRouteId(),apiInfo.getApiName());
    }catch (Exception e){
        log.error("id为{}的接口初始化失败，检查注册表。",apiInfo.getId(),e);
    }
}
return routes.build();
```



到这里，我们完成了网关每次启动后，都能够获取最新的api_info并进行路由注册。

但是我们还没有做到`主动更新路由`。

说到主动更新路由，我们来看看被动更新路由有什么弊端吧。

### 被动更新弊端

被动更新，我这边有两种方案。

1. 网关监听。
2. 定时任务。

网关监听的话，路由更新会非常频繁，很影响服务。定时任务更新的话，无法处理紧急的更新，只能重启网关。

因此，我们一定是需要一个主动更新的策略的。

### 主动更新的策略

相信很多同学都已经想到该怎么做了。

就是加MQ。

后端直接通过rabbitMQ发给网关的消费者，网关接收到这条消息后，再跑一遍路由注册即可。

但是这还没完呢！

这又引出一个问题：刷新时网关接收到请求该怎么办？

### 更新时大量请求如何处理

这边假设我们网关只有一台。在路由更新时，网关没法提供路由，请求全部404，咋办？

最简单就是上多一个实例，哈哈哈。

但是我这边有个点子，通过创建两个路由Bean去模拟双实例。

具体方案如下：

1. 网关收到消息，准备进行刷新
2. 将主Bean配置复制给从Bean。
3. 将服务切换到从Bean。
4. 主Bean更新。
5. 将服务切换到主Bean。

这样，就可以在一台实例内进行主从切换了。

## 总结

这边就是我在最近一周整理API开放平台接入时找到的小问题（我认为的）。其中涉及到一些限流策略、调用次数统计、路由动态更新等问题的分析和探讨。我认为有些部分还是很值得深入的，希望能够给大家带来思考和帮助，也抛砖引玉，也请求各位大牛能够指出我的错误。



